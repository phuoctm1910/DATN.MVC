@{
    ViewData["Title"] = "Thống Kê Tin Nhắn";
}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

<div class="card-header">
    <h2><i class="fas fa-chart-bar me-1"></i> Thống Kê Tổng Số Tin Nhắn</h2>
    <button id="exportChart" class="btn btn-success">Export Biểu Đồ</button>
</div>
<div class="card-body">
    <canvas id="messageChart" width="100%" height="50"></canvas>
</div>
<div class="card-footer">
    <small class="text-muted">Cập nhật gần nhất lúc: @DateTime.Now.ToString("HH:mm:ss dd/MM/yyyy")</small>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            let chart; // Biến lưu biểu đồ

            // Lấy dữ liệu từ API
            $.ajax({
                url: "https://localhost:7296/api/Message/thongke", // Đường dẫn API
                method: "GET",
                success: function (data) {
                    const labels = data.map(item => `${item.month}/${item.year}`);
                    const totalMessages = data.map(item => item.totalMessages);

                    const ctx = document.getElementById('messageChart').getContext('2d');
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Tổng số tin nhắn',
                                data: totalMessages,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true, position: 'top' },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            return `${context.dataset.label}: ${context.raw}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: { display: true, text: 'Tháng/Năm' }
                                },
                                y: {
                                    title: { display: true, text: 'Số lượng tin nhắn' },
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function (value) {
                                            // Hiển thị cố định các giá trị nhỏ
                                            if ([0, 2, 4, 6, 8, 100, 500, 1000].includes(value)) {
                                                return value;
                                            }
                                            // Sau 1000, hiển thị động (cách 1000 đơn vị)
                                            if (value > 1000) {
                                                return value % 1000 === 0 ? value : null;
                                            }
                                            if (value > 5000) {
                                                return value % 5000 === 0 ? value : null;
                                            }
                                            return null;
                                        },
                                        stepSize: 1 // Bước cơ bản, callback sẽ quyết định giá trị hiển thị
                                    },
                                    min: 0 // Đảm bảo bắt đầu từ 0
                                }
                            }
                        }
                    });
                },
                error: function (xhr, status, error) {
                    console.error("Lỗi khi lấy thống kê:", error);
                }
            });

            // Export Biểu Đồ
            $('#exportChart').on('click', function () {
                const canvas = document.getElementById('messageChart');
                const canvasImage = canvas.toDataURL('image/png'); // Chuyển Canvas thành hình ảnh

                // Tạo tài liệu PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();

                // Thêm hình ảnh vào PDF
                pdf.addImage(canvasImage, 'PNG', 10, 10, 190, 100); // Vị trí và kích thước
                pdf.save('message_chart.pdf'); // Lưu file PDF
            });
        });
    </script>
}


