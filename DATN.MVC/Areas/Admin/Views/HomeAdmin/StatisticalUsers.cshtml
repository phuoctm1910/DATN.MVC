@{
    ViewData["Title"] = "Thống Kê Người Dùng";
}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Thêm Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

       
            <div class="card-header">
            <h2>  <i class="fas fa-chart-bar me-1"></i>Thống Kê Người Dùng Đăng Ký</h2>
             <button id="exportChart" class="btn btn-success">Export Biểu Đồ</button>
            </div>
            <div class="card-body"><canvas id="registrationChart" width="100%" height="50"></canvas></div>
            <div class="card-footer small text-muted">Cập nhật gần nhất lúc: @DateTime.Now.ToString("HH:mm:ss dd/MM/yyyy")</div>


<script>
    $(document).ready(function () {
        // Lấy dữ liệu từ API
        $.ajax({
            url: "https://localhost:7296/api/User/GetAllAnalysis", // Đường dẫn API
            method: "GET",
            dataType: "json",
            success: function (data) {
                console.log(data); // Kiểm tra dữ liệu từ API

                // Chuẩn bị dữ liệu cho biểu đồ
                const labels = data.map(item => item.date); // Lấy các ngày từ API
                const registrations = data.map(item => item.totalRegistrations); // Lấy số lượng đăng ký từ API

                // Vẽ biểu đồ dạng cột
                const ctx = document.getElementById('registrationChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar', // Loại biểu đồ cột
                    data: {
                        labels: labels, // Các nhãn trục X
                        datasets: [{
                            label: 'Số lượng người đăng ký', // Nhãn dữ liệu
                            data: registrations, // Số lượng đăng ký
                            backgroundColor: 'rgba(75, 192, 192, 0.6)', // Màu nền cột
                            borderColor: 'rgba(75, 192, 192, 1)', // Màu viền cột
                            borderWidth: 1 // Độ dày viền
                        }]
                    },
                    options: {
                        responsive: true, // Responsive trên mọi thiết bị
                        plugins: {
                            legend: {
                                display: true, // Hiển thị chú thích
                                position: 'top'
                            },
                            tooltip: {
                                enabled: true // Hiển thị tooltip khi hover
                            },
                            title: {
                                display: true,
                                text: 'Thống kê số lượng người đăng ký' // Tiêu đề biểu đồ
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Ngày' // Tiêu đề trục X
                                },
                                grid: {
                                    display: true, // Hiển thị lưới trên trục X
                                    color: 'rgba(200, 200, 200, 0.3)' // Màu lưới trục X
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Số lượng đăng ký' // Tiêu đề trục Y
                                },
                                beginAtZero: true, // Bắt đầu từ 0
                                ticks: {
                                    stepSize: 1, // Khoảng cách giữa các giá trị trên trục Y là 1
                                    callback: function (value) {
                                        return Number.isInteger(value) ? value : null; // Chỉ hiển thị số nguyên
                                    }
                                },
                                grid: {
                                    display: true, // Hiển thị lưới trên trục Y
                                    color: 'rgba(200, 200, 200, 0.3)' // Màu lưới trục Y
                                }
                            }
                        }
                    }
                });
            },
            error: function (xhr, status, error) {
                console.error("Lỗi khi lấy dữ liệu từ API:", error); // Thông báo lỗi
            }
        });

        $('#exportChart').on('click', function () {
            const canvas = document.getElementById('registrationChart');
            const canvasImage = canvas.toDataURL('image/png'); // Chuyển Canvas thành hình ảnh

            // Tạo tài liệu PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            // Thêm hình ảnh vào PDF
            pdf.addImage(canvasImage, 'PNG', 10, 10, 190, 100); // Vị trí và kích thước
            pdf.save('users_chart.pdf'); // Lưu file PDF
        });
    });

</script>


