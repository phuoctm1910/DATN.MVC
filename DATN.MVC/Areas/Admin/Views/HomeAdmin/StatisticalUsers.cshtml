@{
    ViewData["Title"] = "Thống Kê Người Dùng";
}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

<div class="card-header">
    <h2><i class="fas fa-chart-bar me-1"></i> Thống Kê Người Dùng Mới</h2>
    <button id="exportChart" class="btn btn-success">Export Biểu Đồ</button>
</div>
<div class="card-body">
    <canvas id="registrationChart" width="100%" height="50"></canvas>
</div>
<div class="card-footer small text-muted">
    Cập nhật gần nhất lúc: @DateTime.Now.ToString("HH:mm:ss dd/MM/yyyy")
</div>

<script>
    $(document).ready(function () {
        // Lấy dữ liệu từ API
        $.ajax({
            url: "https://localhost:7296/api/User/GetAllAnalysis", // Đường dẫn API
            method: "GET",
            dataType: "json",
            success: function (data) {
                console.log(data); // Kiểm tra dữ liệu từ API

                // Giả sử mỗi phần tử "item" trong data có dạng:
                // {
                //    "date": "2023-01-10", // Hoặc "yyyy-MM-dd"
                //    "totalRegistrations": 15
                // }

                // Định dạng lại ngày sang "MM/yyyy".
                // Nếu muốn "dd/MM/yyyy" chỉ cần chỉnh lại trong phần return `${day}/${month}/${year}`
                const labels = data.map(item => {
                    const dateObj = new Date(item.date);
                    const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                    const year = dateObj.getFullYear();
                    return `${month}/${year}`; // Tháng/Năm
                });

                // Lấy số lượng đăng ký từ API
                const registrations = data.map(item => item.totalRegistrations);

                // Vẽ biểu đồ dạng cột
                const ctx = document.getElementById('registrationChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Số lượng người mới',
                            data: registrations,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                enabled: true
                            },
                            title: {
                                display: true,
                                text: 'Thống kê số lượng người đăng ký'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    // Đổi tiêu đề trục X từ "Năm - Tháng" sang "Tháng/Năm"
                                    text: 'Tháng/Năm'
                                },
                                grid: {
                                    display: true,
                                    color: 'rgba(200, 200, 200, 0.3)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Số lượng đăng ký'
                                },
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    callback: function (value) {
                                        return Number.isInteger(value) ? value : null;
                                    }
                                },
                                grid: {
                                    display: true,
                                    color: 'rgba(200, 200, 200, 0.3)'
                                }
                            }
                        }
                    }
                });
            },
            error: function (xhr, status, error) {
                console.error("Lỗi khi lấy dữ liệu từ API:", error);
            }
        });

        // Chức năng export biểu đồ dưới dạng PDF
        $('#exportChart').on('click', function () {
            const canvas = document.getElementById('registrationChart');
            const canvasImage = canvas.toDataURL('image/png'); // Chuyển Canvas thành hình ảnh

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            // Thêm hình ảnh vào PDF (tọa độ 10,10; kích thước 190 x 100)
            pdf.addImage(canvasImage, 'PNG', 10, 10, 190, 100);
            pdf.save('users_chart.pdf');
        });
    });
</script>
